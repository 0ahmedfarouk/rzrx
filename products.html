<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RZRX — المتجر</title>
  <link rel="icon" href="./assets/favicon.svg"/>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand"><span class="logo"><img src="./assets/logo.svg" width="24" height="24" alt=""/></span> RZRX</div>
      <div><a href="./index.html">الرئيسية</a> · <a href="./dashboard.html">حسابي</a></div>
    </nav>

    <section class="card">
      <h1>المتجر</h1>
      <p class="muted">قائمة المنتجات المتاحة للشراء باستخدام الكريدت.</p>
      <div id="grid" class="grid products"></div>
    </section>

    <footer class="footer">© <span id="y"></span> RZRX</footer>
  </div>

  <div class="toast"></div>
  <script type="module">
    import { listProducts, secureBuy, getToken } from './js/api.js';
    import './js/auth.js';
    import { toast } from './js/ui.js';
    import './js/config.js';

    async function render(){
      try{
        const data = await listProducts();
        const grid = document.getElementById('grid');
        if(!data || !data.length){
          grid.innerHTML = '<div class="card">لا توجد منتجات حالياً.</div>'; return;
        }
        grid.innerHTML = data.map(p => `
          <div class="card">
            <h3>${p.name}</h3>
            <div class="muted">السعر: <span class="badge">${p.price} كريدت</span></div>
            <div class="actions">
              <button class="btn" onclick="buy('${p.id}','${p.name}',${p.price})">شراء</button>
            </div>
          </div>
        `).join('');
      }catch(e){
        document.getElementById('grid').innerHTML = '<div class="card">تعذر تحميل المنتجات.</div>';
      }
    }

    window.buy = async (id, name, price)=>{
      if(!getToken()){ location.href = './dashboard.html#login-required'; return; }
      try{
        const out = await secureBuy(id);
        toast(\`تم شراء \${name} ✅ — رصيدك الآن: \${out.credits}\`, 'ok');
      }catch(e){ toast(e.message || 'فشل الشراء', 'err'); }
    }

    render(); document.getElementById('y').textContent=new Date().getFullYear();
  </script>
</body>
</html>
